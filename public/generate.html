<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeCraft - Generate Meme</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .preview-area {
            min-height: 300px;
            background-image: url("data:image/svg+xml,%3csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3e%3cdefs%3e%3cpattern id='a' patternUnits='userSpaceOnUse' width='20' height='20' patternTransform='scale(2) rotate(0)'%3e%3crect x='0' y='0' width='100%25' height='100%25' fill='%23f8fafc'/%3e%3cpath d='m0 10h20M10 0v20' stroke-width='0.5' stroke='%23e2e8f0' fill='none'/%3e%3c/pattern%3e%3c/defs%3e%3crect width='100%25' height='100%25' fill='url(%23a)'/%3e%3c/svg%3e");
        }
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .error-shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .char-limit-warning {
            color: #f59e0b;
        }
        .char-limit-error {
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<!-- Header -->
<header class="gradient-bg text-white py-6">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">üé≠ MemeCraft Generator</h1>
                <p id="preset-info" class="text-lg opacity-90">Loading preset...</p>
            </div>
            <button onclick="goBack()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                ‚Üê Kembali
            </button>
        </div>
    </div>
</header>

<!-- Error Alert -->
<div id="error-alert" class="container mx-auto px-4 pt-4 hidden">
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg error-shake">
        <div class="flex items-center">
            <div class="text-2xl mr-3">‚ùå</div>
            <div>
                <p class="font-bold">Error!</p>
                <p id="error-message"></p>
            </div>
            <button onclick="hideErrorAlert()" class="ml-auto text-red-500 hover:text-red-700">
                ‚úï
            </button>
        </div>
    </div>
</div>

<!-- Success Alert -->
<div id="success-alert" class="container mx-auto px-4 pt-4 hidden">
    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg">
        <div class="flex items-center">
            <div class="text-2xl mr-3">‚úÖ</div>
            <div>
                <p class="font-bold">Berhasil!</p>
                <p id="success-message"></p>
            </div>
            <button onclick="hideSuccessAlert()" class="ml-auto text-green-500 hover:text-green-700">
                ‚úï
            </button>
        </div>
    </div>
</div>

<!-- Main Content -->
<main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Form Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <!-- Example Image (moved to top) -->
            <div id="example-image-container" class="mb-6 hidden">
                <div class="text-xs text-gray-500 mb-2">Contoh hasil meme preset ini:</div>
                <img id="example-image"
                     src=""
                     alt="Contoh Meme"
                     class="mx-auto rounded-lg shadow border border-gray-200 bg-gray-50"
                     style="display:block;max-width:70%;height:auto;object-fit:contain;">
            </div>

            <h2 class="text-2xl font-bold mb-6">Atur Meme Anda</h2>

            <!-- File Upload Section -->
            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Upload Gambar atau Masukkan URL
                </label>

                <!-- Drag & Drop Zone dengan Label -->
                <div id="drop-zone" class="drop-zone rounded-lg p-8 text-center mb-4">
                    <div id="drop-content">
                        <div class="text-4xl mb-4">üìÅ</div>
                        <p class="text-lg font-medium text-gray-700 mb-2">Drag & Drop gambar di sini</p>
                        <p class="text-sm text-gray-500 mb-4">atau klik tombol di bawah untuk memilih file (PNG/JPG, max 3MB)</p>
                        <!-- Gunakan LABEL untuk trigger file input -->
                        <label for="file-input" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer inline-block transition-colors">
                            Pilih File
                        </label>
                    </div>
                    <!-- File input dengan ID yang sesuai dengan label -->
                    <input type="file" id="file-input" accept="image/png,image/jpeg,image/jpg" class="hidden">
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="hidden mb-4">
                    <div class="flex items-center justify-between text-sm text-gray-600 mb-1">
                        <span>Mengupload...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Alternative URL Input -->
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">atau</span>
                    </div>
                </div>

                <input type="url" id="overlay-url"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-4"
                       placeholder="https://example.com/image.jpg">
                <p class="text-xs text-gray-500 mt-1">Masukkan URL gambar sebagai alternatif</p>
            </div>

            <!-- Resize Mode -->
            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Mode Resize
                </label>
                <select id="resize-mode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="fill">Fill - Isi penuh (Rekomendasi)</option>
                    <option value="stretch">Stretch - Regangkan</option>
                    <option value="lock">Lock - Lock rasio resize/crop</option>
                </select>
            </div>

            <!-- Dynamic Text Fields -->
            <div id="text-fields">
                <!-- Text fields akan diisi secara dinamis berdasarkan preset API response -->
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="mt-2 text-gray-600">Memuat form text...</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col gap-3 mt-6">
                <button onclick="generateMeme()" id="generate-btn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    üé® Generate Meme
                </button>
                <button onclick="resetForm()"
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg transition-colors">
                    üîÑ Reset Form
                </button>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6">Preview</h2>

            <!-- Loading State -->
            <div id="preview-loading" class="preview-area flex items-center justify-center hidden">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                    <p class="text-gray-600">Membuat meme...</p>
                    <p class="text-sm text-gray-500 mt-2">Mohon tunggu sebentar</p>
                </div>
            </div>

            <!-- Preview Result -->
            <div id="preview-result" class="preview-area flex items-center justify-center border-2 border-dashed border-gray-300 rounded-lg">
                <div class="text-center text-gray-500">
                    <div class="text-6xl mb-4">üñºÔ∏è</div>
                    <p class="text-lg font-medium">Preview meme akan muncul di sini</p>
                    <p class="text-sm mt-2">Upload gambar atau masukkan URL, lalu klik "Generate Meme"</p>
                </div>
            </div>

            <!-- Download Button (hidden initially) -->
            <button id="download-btn" onclick="downloadMeme()"
                    class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-medium hidden transition-colors">
                ‚¨áÔ∏è Download Meme
            </button>
        </div>
    </div>
</main>

<script>
    const API_BASE_URL = 'http://127.0.0.1:3000'; // Ganti dengan URL API Anda
    let currentPreset = null;
    let generatedMemeUrl = null;
    let uploadedImageUrl = null;

    // Unified error handling function
    async function handleApiError(response) {
        try {
            const errorData = await response.json();
            return errorData.message || `HTTP Error ${response.status}`;
        } catch {
            return `HTTP Error ${response.status}`;
        }
    }

    // Alert functions
    function showErrorAlert(message) {
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-alert').classList.remove('hidden');
        setTimeout(() => hideErrorAlert(), 7000);
    }

    function hideErrorAlert() {
        document.getElementById('error-alert').classList.add('hidden');
    }

    function showSuccessAlert(message) {
        document.getElementById('success-message').textContent = message;
        document.getElementById('success-alert').classList.remove('hidden');
        setTimeout(() => hideSuccessAlert(), 5000);
    }

    function hideSuccessAlert() {
        document.getElementById('success-alert').classList.add('hidden');
    }

    // Simplified file validation - only basic frontend checks
    function validateFile(file) {
        if (!file) return 'File tidak valid';

        // Check file type - hanya PNG/JPEG
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
        if (!allowedTypes.includes(file.type)) {
            return 'File harus berupa PNG atau JPEG';
        }

        // Check file size - max 3MB
        if (file.size > 3 * 1024 * 1024) {
            return 'Ukuran file maksimal 3MB';
        }

        return null; // Valid
    }

    // File upload initialization - MENGGUNAKAN LABEL APPROACH
    function initializeFileUpload() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        // TIDAK MENGGUNAKAN click event pada dropZone
        // Label akan menangani click secara otomatis

        // Drag and drop events only
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');

            const files = e.dataTransfer?.files;
            if (files && files.length > 0) {
                handleFileSelection(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = e.target?.files;
            if (files && files.length > 0) {
                handleFileSelection(files[0]);
            }
        });
    }

    // Handle file selection
    async function handleFileSelection(file) {
        const error = validateFile(file);
        if (error) {
            showErrorAlert(error);
            return;
        }

        try {
            await uploadFile(file);
        } catch (error) {
            showErrorAlert(error.message);
        }
    }

    // Upload file to server
    async function uploadFile(file) {
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');

        uploadProgress.classList.remove('hidden');

        const formData = new FormData();
        formData.append('file', file);

        try {
            const xhr = new XMLHttpRequest();

            return new Promise((resolve, reject) => {
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressPercent.textContent = `${percent}%`;
                    }
                });

                xhr.addEventListener('load', async () => {
                    uploadProgress.classList.add('hidden');

                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            uploadedImageUrl = response.direct_url || response.file_url || response.path;

                            if (uploadedImageUrl) {
                                showFilePreview(file.name, uploadedImageUrl);
                                showSuccessAlert(`File ${file.name} berhasil diupload!`);
                                document.getElementById('overlay-url').value = '';
                                resolve(uploadedImageUrl);
                            } else {
                                reject(new Error('Server tidak mengembalikan URL file'));
                            }
                        } catch (parseError) {
                            reject(new Error('Response tidak valid dari server'));
                        }
                    } else {
                        // API error - akan selalu ada properti "message"
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            reject(new Error(errorResponse.message));
                        } catch {
                            reject(new Error(`Upload gagal: ${xhr.statusText}`));
                        }
                    }
                });

                xhr.addEventListener('error', () => {
                    uploadProgress.classList.add('hidden');
                    reject(new Error('Network error'));
                });

                xhr.open('POST', `${API_BASE_URL}/upload`);
                xhr.send(formData);
            });

        } catch (error) {
            uploadProgress.classList.add('hidden');
            throw error;
        }
    }

    // Show file preview - MENGGUNAKAN LABEL
    function showFilePreview(fileName, fileUrl) {
        document.getElementById('drop-content').innerHTML = `
            <img src="${fileUrl}" alt="Preview" class="mx-auto mb-4 rounded-lg shadow max-h-40 object-contain bg-gray-100 border border-gray-300">
            <div class="text-green-500 text-4xl mb-2">‚úÖ</div>
            <p class="text-lg font-medium text-gray-700 mb-1">File berhasil diupload!</p>
            <p class="text-sm text-gray-600 mb-3 truncate">${fileName}</p>
            <label for="file-input" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg cursor-pointer inline-block transition-colors">
                Ganti File
            </label>
        `;
        // Set overlay-url input to the uploaded file's direct URL
        document.getElementById('overlay-url').placeholder = fileUrl;
    }

    // Reset file upload - MENGGUNAKAN LABEL
    function resetFileUpload() {
        uploadedImageUrl = null;
        document.getElementById('file-input').value = '';
        document.getElementById('drop-content').innerHTML = `
            <div class="text-4xl mb-4">üìÅ</div>
            <p class="text-lg font-medium text-gray-700 mb-2">Drag & Drop gambar di sini</p>
            <p class="text-sm text-gray-500 mb-4">atau klik tombol di bawah untuk memilih file (PNG/JPG, max 3MB)</p>
            <label for="file-input" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer inline-block transition-colors">
                Pilih File
            </label>
        `;
    }

    // Get preset from URL
    function getPresetFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('preset');
    }

    // Load preset details
    async function loadPresetDetails(presetId) {
        try {
            const response = await fetch(`${API_BASE_URL}/presets/${presetId}`);

            if (response.status !== 200) {
                const errorMessage = await handleApiError(response);
                throw new Error(errorMessage);
            }

            currentPreset = await response.json();
            updatePresetInfo();
            setupTextFields();

        } catch (error) {
            showErrorAlert(`Gagal memuat preset: ${error.message}`);
            setTimeout(() => goBack(), 3000);
        }
    }

    // Update preset info and show example image if available
    function updatePresetInfo() {
        const presetName = currentPreset?.name || getPresetFromURL() || 'Unknown';
        document.getElementById('preset-info').textContent = `Preset: ${presetName}`;

        // Show example image if available
        const exampleImage = currentPreset?.example_image;
        const exampleContainer = document.getElementById('example-image-container');
        const exampleImg = document.getElementById('example-image');
        if (exampleImage) {
            exampleImg.src = exampleImage;
            exampleImg.alt = `Contoh Meme ${presetName}`;
            exampleContainer.classList.remove('hidden');
        } else {
            exampleContainer.classList.add('hidden');
        }
    }

    // Character counter for text fields with max_chars
    function addCharacterCounter(fieldName, maxChars) {
        const textarea = document.getElementById(`text-${fieldName}`);
        const counter = document.getElementById(`char-count-${fieldName}`);

        if (textarea && counter) {
            textarea.addEventListener('input', function() {
                const currentLength = this.value.length;
                counter.textContent = `${currentLength}/${maxChars}`;

                // Change color based on character count
                counter.classList.remove('char-limit-warning', 'char-limit-error');

                if (currentLength >= maxChars) {
                    counter.classList.add('char-limit-error');
                    this.classList.add('border-red-500');
                } else if (currentLength >= maxChars * 0.8) {
                    counter.classList.add('char-limit-warning');
                    this.classList.remove('border-red-500');
                } else {
                    this.classList.remove('border-red-500');
                }
            });
        }
    }

    // Setup text fields dynamically based on preset API response
    function setupTextFields() {
        const textFieldsContainer = document.getElementById('text-fields');
        if (!textFieldsContainer) {
            console.error('Text fields container tidak ditemukan');
            return;
        }

        // Ambil text_boxes dari response API preset
        const textBoxes = currentPreset?.text_boxes || [];

        if (textBoxes.length === 0) {
            // Fallback jika tidak ada text_boxes di response
            textFieldsContainer.innerHTML = `
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Teks <span class="text-red-500">*</span>
                    </label>
                    <textarea id="text-content" rows="3"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                              placeholder="Masukkan teks untuk meme..." required></textarea>
                    <p class="text-xs text-gray-500 mt-1">Tidak ada batasan karakter</p>
                </div>
            `;
            return;
        }

        // Generate text fields berdasarkan text_boxes dari API
        textFieldsContainer.innerHTML = textBoxes.map(textBox => {
            const fieldName = textBox.name || 'text';
            const maxChars = textBox.max_chars || null;
            const displayName = fieldName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

            return `
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ${displayName} <span class="text-red-500">*</span>
                        ${maxChars ? `<span class="text-gray-500 text-xs font-normal">(max ${maxChars} karakter)</span>` : ''}
                    </label>
                    <textarea id="text-${fieldName}" rows="3"
                              ${maxChars ? `maxlength="${maxChars}"` : ''}
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                              placeholder="Masukkan ${displayName.toLowerCase()}..." required></textarea>
                    ${maxChars ? `
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-xs text-gray-500">Maksimal ${maxChars} karakter</p>
                        <span id="char-count-${fieldName}" class="text-xs text-gray-400">0/${maxChars}</span>
                    </div>` : ''}
                </div>
            `;
        }).join('');

        // Tambahkan character counter untuk field yang memiliki max_chars
        textBoxes.forEach(textBox => {
            if (textBox.max_chars && textBox.name) {
                addCharacterCounter(textBox.name, textBox.max_chars);
            }
        });
    }

    // Collect text data from dynamic fields
    function collectTextData() {
        const textData = {};
        const textBoxes = currentPreset?.text_boxes || [];

        if (textBoxes.length === 0) {
            // Fallback untuk form statis
            const contentField = document.getElementById('text-content');
            if (contentField) {
                textData.content = contentField.value.trim();
            }
        } else {
            // Kumpulkan data dari field dinamis
            textBoxes.forEach(textBox => {
                const fieldName = textBox.name;
                const textarea = document.getElementById(`text-${fieldName}`);
                if (textarea) {
                    textData[fieldName] = textarea.value.trim();
                }
            });
        }

        return textData;
    }

    // Validate text fields
    function validateTextFields() {
        const textBoxes = currentPreset?.text_boxes || [];
        let hasEmptyField = false;
        let hasOverLimitField = false;

        if (textBoxes.length === 0) {
            // Validate fallback field
            const contentField = document.getElementById('text-content');
            if (contentField && !contentField.value.trim()) {
                contentField.classList.add('border-red-500');
                hasEmptyField = true;
            } else if (contentField) {
                contentField.classList.remove('border-red-500');
            }
        } else {
            // Validate dynamic fields
            textBoxes.forEach(textBox => {
                const fieldName = textBox.name;
                const textarea = document.getElementById(`text-${fieldName}`);

                if (textarea) {
                    const value = textarea.value.trim();

                    if (!value) {
                        hasEmptyField = true;
                        textarea.classList.add('border-red-500');
                    } else {
                        textarea.classList.remove('border-red-500');

                        // Check character limit
                        if (textBox.max_chars && value.length > textBox.max_chars) {
                            hasOverLimitField = true;
                            textarea.classList.add('border-red-500');
                        }
                    }
                }
            });
        }

        return { hasEmptyField, hasOverLimitField };
    }

    // Generate meme
    async function generateMeme() {
        const presetId = getPresetFromURL();
        const overlayUrl = document.getElementById('overlay-url').value.trim();
        const resizeMode = document.getElementById('resize-mode').value;

        // Use uploaded image or URL
        let imageUrl = uploadedImageUrl || overlayUrl;

        if (!imageUrl) {
            showErrorAlert('Mohon upload gambar atau masukkan URL gambar');
            return;
        }

        // Validate text fields
        const validation = validateTextFields();

        if (validation.hasEmptyField) {
            showErrorAlert('Mohon isi semua field teks yang diperlukan');
            return;
        }

        if (validation.hasOverLimitField) {
            showErrorAlert('Beberapa teks melebihi batas karakter yang diizinkan');
            return;
        }

        // Collect text data
        const textData = collectTextData();

        const payload = {
            overlay: imageUrl,
            resize_mode: resizeMode,
            text: textData
        };

        try {
            showLoading();

            const response = await fetch(`${API_BASE_URL}/presets/${presetId}/memes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (response.status !== 200) {
                const errorMessage = await handleApiError(response);
                throw new Error(errorMessage);
            }

            // Handle response - could be JSON or blob
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                // Prefer image_url, fallback to meme_url, url, file_url
                generatedMemeUrl = result.image_url || result.meme_url || result.url || result.file_url;
            } else {
                // Assume image blob
                const blob = await response.blob();
                generatedMemeUrl = URL.createObjectURL(blob);
            }

            if (!generatedMemeUrl) {
                throw new Error('Server tidak mengembalikan meme');
            }

            showPreview(generatedMemeUrl);
            showSuccessAlert('Meme berhasil dibuat!');

        } catch (error) {
            showErrorAlert(`Gagal membuat meme: ${error.message}`);
            hideLoading();
        }
    }

    // Loading state management
    function showLoading() {
        const generateBtn = document.getElementById('generate-btn');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div>Membuat Meme...';

        document.getElementById('preview-loading').classList.remove('hidden');
        document.getElementById('preview-result').classList.add('hidden');
        document.getElementById('download-btn').classList.add('hidden');
    }

    function hideLoading() {
        const generateBtn = document.getElementById('generate-btn');
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'üé® Generate Meme';

        document.getElementById('preview-loading').classList.add('hidden');
        document.getElementById('preview-result').classList.remove('hidden');
    }

    function showPreview(memeUrl) {
        hideLoading();

        document.getElementById('preview-result').innerHTML = `
            <img src="${memeUrl}" alt="Generated Meme"
                 class="max-w-full max-h-full object-contain rounded-lg shadow-lg"
                 style="max-height: 400px;">
        `;

        // Always show download button after meme is generated
        document.getElementById('download-btn').classList.remove('hidden');
    }

    // Download meme
    function downloadMeme() {
        if (generatedMemeUrl) {
            const link = document.createElement('a');
            link.href = generatedMemeUrl;
            link.download = `meme-${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showSuccessAlert('Download dimulai...');
        }
    }

    // Reset form
    function resetForm() {
        resetFileUpload();
        document.getElementById('overlay-url').value = '';
        document.getElementById('resize-mode').value = 'fill';

        // Reset dynamic text fields
        const textBoxes = currentPreset?.text_boxes || [];

        if (textBoxes.length === 0) {
            // Reset fallback field
            const contentField = document.getElementById('text-content');
            if (contentField) {
                contentField.value = '';
                contentField.classList.remove('border-red-500');
            }
        } else {
            // Reset dynamic fields
            textBoxes.forEach(textBox => {
                const textarea = document.getElementById(`text-${textBox.name}`);
                const counter = document.getElementById(`char-count-${textBox.name}`);

                if (textarea) {
                    textarea.value = '';
                    textarea.classList.remove('border-red-500');
                }

                if (counter && textBox.max_chars) {
                    counter.textContent = `0/${textBox.max_chars}`;
                    counter.classList.remove('char-limit-warning', 'char-limit-error');
                }
            });
        }

        document.getElementById('preview-result').innerHTML = `
            <div class="text-center text-gray-500">
                <div class="text-6xl mb-4">üñºÔ∏è</div>
                <p class="text-lg font-medium">Preview meme akan muncul di sini</p>
                <p class="text-sm mt-2">Upload gambar atau masukkan URL, lalu klik "Generate Meme"</p>
            </div>
        `;

        document.getElementById('download-btn').classList.add('hidden');
        document.getElementById('upload-progress').classList.add('hidden');

        generatedMemeUrl = null;
        showSuccessAlert('Form berhasil direset');
    }

    // Navigation
    function goBack() {
        window.location.href = 'index.html';
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', function() {
        const presetId = getPresetFromURL();

        if (!presetId) {
            showErrorAlert('Preset tidak ditemukan');
            setTimeout(() => goBack(), 2000);
            return;
        }

        initializeFileUpload();
        loadPresetDetails(presetId);
    });
</script>
</body>
</html>
